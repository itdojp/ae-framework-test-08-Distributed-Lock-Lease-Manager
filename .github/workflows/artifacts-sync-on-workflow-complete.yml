name: Artifacts Sync On Workflow Complete

on:
  workflow_run:
    workflows:
      - CI Basic
      - AE Eval Fast
      - AE Eval Full
    types:
      - completed

permissions:
  contents: write
  actions: read

concurrency:
  group: artifacts-sync-on-complete-${{ github.event.workflow_run.id }}
  cancel-in-progress: false

jobs:
  import-and-index:
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Import completed run artifact and refresh index
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          REPO_SLUG: ${{ github.repository }}
        run: |
          set -euo pipefail

          case "${WORKFLOW_NAME}" in
            "AE Eval Fast")
              ARTIFACT_NAME="ae-eval-fast-artifacts"
              ;;
            "AE Eval Full")
              ARTIFACT_NAME="ae-eval-full-artifacts"
              ;;
            "CI Basic")
              ARTIFACT_NAME="ci-basic-logs"
              ;;
            *)
              echo "skip: unsupported workflow ${WORKFLOW_NAME}"
              exit 0
              ;;
          esac

          if compgen -G "artifacts/runs/gha-${RUN_ID}-*" > /dev/null; then
            echo "skip: already imported run ${RUN_ID}"
            exit 0
          fi

          scripts/import-gha-artifact.sh "${RUN_ID}" --artifact "${ARTIFACT_NAME}" --repo "${REPO_SLUG}"
          bash scripts/backfill-imported-run-metadata.sh
          node scripts/generate-run-index.mjs

      - name: Commit and push changes
        run: |
          if git diff --quiet -- artifacts/runs; then
            echo "No artifact changes."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add artifacts/runs
          git commit -m "chore: sync artifacts for completed workflow run ${{ github.event.workflow_run.id }}"
          git push
