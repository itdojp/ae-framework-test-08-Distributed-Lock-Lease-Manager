name: Artifacts Sync On Workflow Complete

on:
  workflow_run:
    workflows:
      - CI Basic
      - AE Eval Fast
      - AE Eval Full
    types:
      - completed

permissions:
  contents: write
  actions: read

concurrency:
  group: artifacts-writer-main
  cancel-in-progress: false

jobs:
  import-and-index:
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Import completed run artifact and refresh index
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
          TRIGGER_RUN_ID: ${{ github.event.workflow_run.id }}
          TRIGGER_WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
          REPO_SLUG: ${{ github.repository }}
        run: |
          set -euo pipefail

          echo "trigger_run_id=${TRIGGER_RUN_ID}"
          echo "trigger_workflow=${TRIGGER_WORKFLOW_NAME}"
          echo "head_sha=${HEAD_SHA}"
          mkdir -p .tmp
          : > .tmp/imported-run-ids.txt

          # 同一head_shaで実行中の関連workflowがある場合、一定時間待ってまとめて取り込む。
          for _ in $(seq 1 18); do
            pending_count="$(gh run list \
              -R "${REPO_SLUG}" \
              --commit "${HEAD_SHA}" \
              --limit 20 \
              --json name,status \
              --jq '[.[] | select((.name=="CI Basic" or .name=="AE Eval Fast" or .name=="AE Eval Full") and .status!="completed")] | length')"
            if [[ "${pending_count}" == "0" ]]; then
              break
            fi
            sleep 10
          done

          imported_count=0
          while IFS=$'\t' read -r run_id workflow_name; do
            [[ -z "${run_id}" || -z "${workflow_name}" ]] && continue

            case "${workflow_name}" in
              "AE Eval Fast")
                artifact_name="ae-eval-fast-artifacts"
                ;;
              "AE Eval Full")
                artifact_name="ae-eval-full-artifacts"
                ;;
              "CI Basic")
                artifact_name="ci-basic-logs"
                ;;
              *)
                continue
                ;;
            esac

            if compgen -G "artifacts/runs/gha-${run_id}-*" > /dev/null; then
              echo "skip: already imported run ${run_id} (${workflow_name})"
              continue
            fi

            echo "import: run_id=${run_id} workflow=${workflow_name} artifact=${artifact_name}"
            scripts/import-gha-artifact.sh "${run_id}" --artifact "${artifact_name}" --repo "${REPO_SLUG}"
            echo "${run_id}" >> .tmp/imported-run-ids.txt
            imported_count=$((imported_count + 1))
          done < <(gh run list \
            -R "${REPO_SLUG}" \
            --commit "${HEAD_SHA}" \
            --limit 20 \
            --json databaseId,name,status,conclusion \
            --jq '.[] | select(.status=="completed" and .conclusion=="success") | [.databaseId,.name] | @tsv')

          if [[ "${imported_count}" == "0" ]]; then
            echo "No runs imported for head_sha=${HEAD_SHA}"
            exit 0
          fi

          bash scripts/backfill-imported-run-metadata.sh
          bash scripts/backfill-gha-run-links.sh
          node scripts/generate-run-index.mjs

      - name: Commit and push changes
        run: |
          if git diff --quiet -- artifacts/runs; then
            echo "No artifact changes."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add artifacts/runs
          git commit -m "chore: sync artifacts for completed workflow run ${{ github.event.workflow_run.id }}"
          if git push; then
            exit 0
          fi

          echo "push rejected; checking whether imported runs already exist on origin/main"
          git fetch origin main

          if [[ ! -f .tmp/imported-run-ids.txt ]]; then
            echo "missing .tmp/imported-run-ids.txt"
            exit 1
          fi

          missing=0
          while IFS= read -r run_id; do
            [[ -z "${run_id}" ]] && continue
            if ! git ls-tree -r --name-only origin/main artifacts/runs | grep -q "^artifacts/runs/gha-${run_id}-"; then
              echo "missing imported run on origin/main: ${run_id}"
              missing=1
            fi
          done < .tmp/imported-run-ids.txt

          if [[ "${missing}" == "0" ]]; then
            echo "All imported runs already present on origin/main; treating as success."
            exit 0
          fi

          echo "push failed and imported runs are still missing on origin/main"
          exit 1
